<!DOCTYPE html>
<html lang="en">
  <!--//////////////////////////////head//////////////////////////////////-->
<head>
    <meta charset="UTF-8">

    <link rel="stylesheet" href="styleIndex.css"> <!-- Connection to the css style -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" 
    crossorigin="anonymous"/> <!-- Connection with bootstrap -->

    <title>Firebase Web</title> <!-- Title pag -->

</head>

  <!--/////////////////////////////body///////////////////////////////////-->
<body>
    <!-- menu -->
    <nav class="navbar bg-body-tertiary" data-bs-theme="dark">
        <form class="container-fluid justify-content-start">
          <a class="navbar-brand" href="#">
            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-bag-heart-fill" viewBox="0 0 20 20">
              <path d="M11.5 4v-.5a3.5 3.5 0 1 0-7 0V4H1v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V4zM8 1a2.5 2.5 0 0 1 2.5 2.5V4h-5v-.5A2.5 2.5 0 0 1 8 1m0 6.993c1.664-1.711 5.825 1.283 0 5.132-5.825-3.85-1.664-6.843 0-5.132"/>
            </svg> <!-- Icon -->
          </a>
          <a class="navbar-brand">Generic store</a> <!-- Title -->
          <a href="queries.html" class="btn btn-sm btn-outline-secondary"> <!-- Link -->
            Queries
          </a>
        </form>
    </nav>
    <!-- menu -->

    <!-- Title -->
    <div class="box">
        <div class="container-fluid pt-3">
          <div class="row">
            <h1 class="gentium-book-plus-bold">Introducir Pedido</h1>
        </div>
        </form>
        </div>
    </div>
    <!-- Title -->

    <!-- Title -->
    <div class="box">

        <div class="container-fluid">
          <div class="row bg-body rounded shadow-sm pt-2"> <!-- Title: Connected to Firestore.-->

            <h1 class="gentium-book-plus-bold">Connected to Firestore Orders</h1>

            <div class="col pb-2"> <!-- Button -->

            <button id="loadDataBtn" class="btn btn-outline-secondary">Show all orders</button>      
            <div id="booksList" class="result-section"></div> <!-- Results -->   

            </div>
        </div>

        </div>

    </div>
    <!-- Title -->

    <!-- Add to Database -->
     <div class="box">
        <!-- Product Container -->
        <div id="product-container" class="container-fluid pt-3 bg-body rounded shadow-sm">
            <!-- This container will display the products -->
        </div>

        <div class="container-fluid pt-3 bg-body rounded shadow-sm">
            <div class="row"> <!-- Title: Add book to the database -->

                <div class="col-1 text-center"> <!-- Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor" class="bi bi-basket2" viewBox="0 0 16 16">
                    <path d="M4 10a1 1 0 0 1 2 0v2a1 1 0 0 1-2 0zm3 0a1 1 0 0 1 2 0v2a1 1 0 0 1-2 0zm3 0a1 1 0 1 1 2 0v2a1 1 0 0 1-2 0z"/>
                    <path d="M5.757 1.071a.5.5 0 0 1 .172.686L3.383 6h9.234L10.07 1.757a.5.5 0 1 1 .858-.514L13.783 6H15.5a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-.623l-1.844 6.456a.75.75 0 0 1-.722.544H3.69a.75.75 0 0 1-.722-.544L1.123 8H.5a.5.5 0 0 1-.5-.5v-1A.5.5 0 0 1 .5 6h1.717L5.07 1.243a.5.5 0 0 1 .686-.172zM2.163 8l1.714 6h8.246l1.714-6z"/>
                    </svg>
                </div>

                <div class="col-11"> <!-- Title -->
                    <h1 class="gentium-book-plus-bold">Add order to the database</h1>
                </div>

            </div>

  <!--/////////////////////////////order///////////////////////////////////-->            
    
            <div class="row"> <!-- enter value -->

                <div class="col pb-4"> <!-- Order Info -->
                    <label for="orderId">Order ID:</label>
                    <input type="number" id="orderId" placeholder="Ej: 1001">
                    <br>
            
                    <label for="purchaseDate" class="pt-4">Purchase Date:</label>
                    <input type="datetime-local" id="purchaseDate">
                    <br>
            
                    <label for="shippingDate" class="pt-4">Shipping Date:</label>
                    <input type="datetime-local" id="shippingDate">
                    <br>
            
                    <label for="status" class="pt-4">Status:</label>
                    <input type="text" id="status" placeholder="Ej: Enviado">
                    <br>
            
                    <label for="trackingNumber" class="pt-4">Tracking Number:</label>
                    <input type="text" id="trackingNumber" placeholder="Ej: ABC123456789">
                </div>
            
                <div class="col pb-4"> <!-- User Info -->
                    <label for="userName">User Name:</label>
                    <input type="text" id="userName" placeholder="Ej: Juan Pérez">
                    <br>
            
                    <label for="userEmail" class="pt-4">Email:</label>
                    <input type="email" id="userEmail" placeholder="Ej: juan@example.com">
                    <br>
            
                    <label for="userPhone" class="pt-4">Phone:</label>
                    <input type="tel" id="userPhone" placeholder="Ej: +57 300 1234567">
                    <br>
            
                    <label for="userAddress" class="pt-4">Address:</label>
                    <input type="text" id="userAddress" placeholder="Ej: Calle Falsa 123, Bogotá">
                </div>
            
            </div>

            
  <!--/////////////////////////////order///////////////////////////////////--> 
            <div class="row">
                <div class="col pb-4">
                    <form id="addProductForm">
                        <div id="productsContainer">
                            <div class="product-entry mb-4">
                        <div class="product-entry mb-4">
                            <label for="productName">Product Name:</label>
                            <input type="text" class="productName" placeholder="Ej: Camiseta Blanca">
                            <br>
            
                            <label for="productDescription" class="pt-2">Description:</label>
                            <input type="text" class="productDescription" placeholder="Ej: 100% algodón">
                            <br>
            
                            <label for="productColor" class="pt-2">Color:</label>
                            <input type="text" class="productColor" placeholder="Ej: Blanco">
                            <br>
            
                            <label for="productPrice" class="pt-2">Price:</label>
                            <input type="number" class="productPrice" placeholder="Ej: 50000">
                            <br>
            
                            <label for="productStock" class="pt-2">Stock:</label>
                            <input type="text" class="productStock" placeholder="Ej: Disponible">
                        </div>
                    </div>
                </div>
            </div>
            

            <div class="row pt-3"> <!-- Button -->

                <div class="col">
                    <button id="addDocBtn" class="btn btn-outline-secondary">Add Order</button>
                    <div id="addMessage" class="result-section"></div>
                </div>

            </div>
        </div>

     </div>
    <!-- Add to Database -->

    <!-- Get Id -->
    <div class="box">
        <div class="container-fluid pt-3 bg-body rounded shadow-sm">
            <div class="row"> <!-- Title: Get Book by id -->

                <div class="col-1 text-center"> <!-- Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor" class="bi bi-binoculars" viewBox="0 0 16 16">
                        <path d="M3 2.5A1.5 1.5 0 0 1 4.5 1h1A1.5 1.5 0 0 1 7 2.5V5h2V2.5A1.5 1.5 0 0 1 10.5 1h1A1.5 1.5 0 0 1 13 2.5v2.382a.5.5 0 0 0 .276.447l.895.447A1.5 1.5 0 0 1 15 7.118V14.5a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 14.5v-3a.5.5 0 0 1 .146-.354l.854-.853V9.5a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5v.793l.854.853A.5.5 0 0 1 7 11.5v3A1.5 1.5 0 0 1 5.5 16h-3A1.5 1.5 0 0 1 1 14.5V7.118a1.5 1.5 0 0 1 .83-1.342l.894-.447A.5.5 0 0 0 3 4.882zM4.5 2a.5.5 0 0 0-.5.5V3h2v-.5a.5.5 0 0 0-.5-.5zM6 4H4v.882a1.5 1.5 0 0 1-.83 1.342l-.894.447A.5.5 0 0 0 2 7.118V13h4v-1.293l-.854-.853A.5.5 0 0 1 5 10.5v-1A1.5 1.5 0 0 1 6.5 8h3A1.5 1.5 0 0 1 11 9.5v1a.5.5 0 0 1-.146.354l-.854.853V13h4V7.118a.5.5 0 0 0-.276-.447l-.895-.447A1.5 1.5 0 0 1 12 4.882V4h-2v1.5a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm4-1h2v-.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5zm4 11h-4v.5a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5zm-8 0H2v.5a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5z"/>
                      </svg>
                </div>

                <div class="col-11"> <!-- Title -->
                    <h1 class="gentium-book-plus-bold">Get Order by id</h1>
                </div>
            </div>

            <div class="row"> <!-- enter value -->
                <div class="col">
                    <label for="getDocId">Order Id:</label> 
                    <input type="text" id="getDocId" placeholder="Ej: 1">
                </div>
            </div>

            <div class="row pt-4"> <!-- Button -->
                <div class="col">
                    <button id="getDocBtn" class="btn btn-outline-secondary">Get Order</button> <!-- Text Button -->
                    <div id="bookDetails" class="result-section"></div>                        
                </div>
            </div>            
        </div>
    </div>
    <!-- Get Id -->

    <!--///////////////////////////////////////////////////////scripts///////////////////////////////////////////////////////// -->
    <!-- module -->
    <script type="module">
        import { FirestoreService } from './modules/firestore_service.js';     // importa clase firestoreservice 

        const firestore = new FirestoreService("order");  // crea instancia servicio coleccion 
        const productService = new FirestoreService("product");

        function displayOrders(containerId, orders) {
    const container = document.getElementById(containerId); // obtiene contenedor por id
    if (!container) {
        console.error(`Element with ID "${containerId}" not found.`);
        return;
    }
    container.innerHTML = ''; // limpia contenido anterior

    if (orders.length === 0) {
        container.innerHTML = '<p>No orders found</p>';
        return;
         // si no ordenes, mensaje
    }


    
    
    //////////////////////// show all orders button ///////////////////

    orders.forEach(order => {
        const orderDiv = document.createElement('div');
        // crea div cada orden
        orderDiv.className = 'order-item'; //  asigna clase
        orderDiv.innerHTML = `
            <h4>Order #${order.orderId}</h4>
            <p><strong>Status:</strong> ${order.status}</p>
            <p><strong>Tracking Number:</strong> ${order.trackingNumber}</p>
            <p><strong>Purchase Date:</strong> ${new Date(order.purchaseDate.seconds * 1000).toLocaleString()}</p>
            <p><strong>Shipping Date:</strong> ${new Date(order.shippingDate.seconds * 1000).toLocaleString()}</p>
            
            <h5>User Info</h5>
            <p>Name: ${order.user.name}</p>
            <p>Email: ${order.user.email}</p>
            <p>Phone: ${order.user.phone}</p>
            <p>Address: ${order.user.address}</p>

            <h5>Products</h5>
            <ul>
                ${order.products.map(product => `
                    <li>
                        <strong>${product.name}</strong> - ${product.description} <br>
                        Color: ${product.color}, Price: $${product.price}, Stock: ${product.stock}
                    </li>
                `).join('')}
            </ul>

            <hr>
        `;
        container.appendChild(orderDiv); 
    });
}

async function displayProducts(containerId) {
    const container = document.getElementById(containerId);
    if (!container) {
        console.error(`Element with ID "${containerId}" not found.`);
        return;
    }
    container.innerHTML = '';

    const products = await productService.getAll();
    if (!products || products.length === 0) {
      container.innerHTML = '<p>No products found</p>';
      return;
    }

    container.innerHTML = `
      <h5>Products</h5>
      <ul>
        ${products.map(product => `
          <li>
            <strong>${product.name}</strong> - ${product.description} <br>
            Color: ${product.color}, Price: $${product.price}, Stock: ${product.stock}
          </li>
        `).join('')}
      </ul>
    `;
  }


  document.getElementById('addProductForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const newProduct = {
      name: form.name.value,
      description: form.description.value,
      color: form.color.value,
      price: parseFloat(form.price.value),
      stock: parseInt(form.stock.value),
    };
    await productService.add(newProduct);
    form.reset();
    displayProducts('product-container');
  });


  window.addEventListener('DOMContentLoaded', () => {
    displayProducts('product-container');
  });


function displayOrderDetails(containerId, order) {
    const container = document.getElementById(containerId); // obtiene contenedor id

    if (!order) {
        container.innerHTML = '<p>Order not found</p>';
        return;
         // si no ordenes, mensaje
    }

    container.innerHTML = `
        <div class="order-item">
            <h3>Order #${order.orderId}</h3>
            <p><strong>Status:</strong> ${order.status}</p>
            <p><strong>Tracking Number:</strong> ${order.trackingNumber}</p>
            <p><strong>Purchase Date:</strong> ${new Date(order.purchaseDate.seconds * 1000).toLocaleString()}</p>
            <p><strong>Shipping Date:</strong> ${new Date(order.shippingDate.seconds * 1000).toLocaleString()}</p>

            <h4>User Info</h4>
            <p>Name: ${order.user.name}</p>
            <p>Email: ${order.user.email}</p>
            <p>Phone: ${order.user.phone}</p>
            <p>Address: ${order.user.address}</p>

            <h4>Products</h4>
            <ul>
                ${order.products.map(async product => {
                    // Send product data to the "product" collection in Firebase
                    await productService.add({
                        name: product.name,
                        description: product.description,
                        color: product.color,
                        price: product.price,
                        stock: product.stock
                    });
                    return `
                        <li>
                            <strong>${product.name}</strong> - ${product.description} <br>
                            Color: ${product.color}, Price: $${product.price}, Stock: ${product.stock}
                        </li>
                    `;
                }).join('')}
            </ul>

            <small>Document ID: ${order.id || 'N/A'}</small>
        </div>
    `;
     // muestra detalles orden en contenedor
}

/////////////////////////////////////show////////////////////////////////////

        document.getElementById("loadDataBtn").addEventListener("click", async () => {
    const docs = await firestore.getAllDocuments(); 
    displayOrders('booksList', docs); // muestra  ordenes en el contenedor id booksList
});
/////////////////////////////////////////// ///////////////////////////////

document.getElementById("addDocBtn").addEventListener("click", async () => {
    const docId = document.getElementById("docId").value.trim();
    const orderId = parseInt(document.getElementById("orderId").value);
    const status = document.getElementById("status").value.trim();
    const trackingNumber = document.getElementById("trackingNumber").value.trim();
    
    const purchaseDate = new Date(document.getElementById("purchaseDate").value);
    const shippingDate = new Date(document.getElementById("shippingDate").value);

    const user = {
        name: document.getElementById("userName").value.trim(),
        email: document.getElementById("userEmail").value.trim(),
        phone: document.getElementById("userPhone").value.trim(),
        address: document.getElementById("userAddress").value.trim()
    };

    //  Recoge  productos desde #productsContainer
    const productEntries = document.querySelectorAll("#productsContainer .product-entry");
    const products = Array.from(productEntries).map(entry => {
        return {
            name: entry.querySelector(".productName").value.trim(),
            description: entry.querySelector(".productDescription").value.trim(),
            color: entry.querySelector(".productColor").value.trim(),
            price: parseFloat(entry.querySelector(".productPrice").value),
            stock: entry.querySelector(".productStock").value.trim()
        };
    });

    if (!docId || isNaN(orderId) || !status || !trackingNumber || !user.name || products.length === 0) {
        alert("Please fill in all required fields.");
        return;
        // valida  todos los campos requeridos 
    }

    const data = {
        orderId,
        status,
        trackingNumber,
        purchaseDate: (purchaseDate.toString()),
        shippingDate: (shippingDate.toString()),
        user,
        products
        // construye el objeto de datos a guardar
    };

    try {
        await firestore.PostDocument(docId, data);
        // guarda documento firebase
        document.getElementById('addMessage').innerHTML = `
            <p style="color: green;">Order added successfully!</p>
        `;
    } catch (error) {
        document.getElementById('addMessage').innerHTML = `
            <p style="color: red;">Error adding order: ${error.message}</p>
        `;
    }
});



document.getElementById("getDocBtn").addEventListener("click", async () => {
    const docId = document.getElementById("getDocId").value.trim();
       // obtiene id documento desde input

    if (!docId) {
        alert("The order ID is needed");
        return;
         // si no ingresa id,  mensaje
    }

    try {
        const doc = await firestore.getDocumentById(docId);
         // obtiene documento por id
        displayOrderDetails('bookDetails', doc);
        // muestra detalles orden contenedor
    } catch (error) {
        document.getElementById('bookDetails').innerHTML = `
            <p style="color: red;">Error: ${error.message}</p>
        `;
    }
});

    </script>
    <!-- module -->

    <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq"
    crossorigin="anonymous">
    </script>

</body>
</html>